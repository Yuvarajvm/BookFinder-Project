{% extends "admin/admin_base.html" %}
{% block title %}Users{% endblock %}
{% block heading %}Manage Users{% endblock %}

{% block content %}
<div class="glass p-3 p-md-4 mb-3">
  <form method="GET" class="row g-2 align-items-center" role="search">
    <div class="col-sm-8 col-md-6">
      <input class="form-control" type="search" name="search" placeholder="Search by username or email..." value="{{ search or '' }}">
    </div>
    <div class="col-auto">
      <button class="btn btn-primary"><i class="fas fa-search me-1"></i>Search</button>
      {% if search %}<a class="btn btn-outline-secondary ms-1" href="{{ url_for('admin_bp.admin_users') }}">Clear</a>{% endif %}
    </div>
    <div class="col text-end">
      <span class="text-muted">Total: {{ total_users or 0 }}</span>
    </div>
  </form>
</div>

{% if users %}
<div class="card glass">
  <div class="card-body">
    <div class="table-responsive">
      <table class="table align-middle">
        <thead class="table-light">
          <tr>
            <th>ID</th><th>Username</th><th>Email</th><th>Books</th><th>Downloads</th><th>Joined</th><th>Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for row in users %}
            {% set u = row.user %}
            <tr>
              <td>{{ u.id }}</td>
              <td class="fw-semibold">{{ u.username }}</td>
              <td>{{ u.email }}</td>
              <td><span class="badge bg-primary">{{ row.book_count }}</span></td>
              <td><span class="badge bg-info">{{ row.download_count }}</span></td>
              <td>{{ u.created_at.strftime('%Y-%m-%d') if u.created_at else 'N/A' }}</td>
              <td>
                <div class="btn-group btn-group-sm">
                  <button class="btn btn-outline-secondary" title="View"><i class="fas fa-eye"></i></button>
                  {% if session.admin_role == 'super_admin' %}
                  <button class="btn btn-outline-danger" title="Delete" onclick="deleteUser({{ u.id }}, '{{ u.username }}')">
                    <i class="fas fa-trash"></i>
                  </button>
                  {% endif %}
                </div>
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>
{% else %}
<div class="card glass">
  <div class="card-body text-center py-5">
    <i class="fas fa-users fa-3x text-muted mb-3"></i>
    {% if search %}
      <h5>No users match your search.</h5>
      <a class="btn btn-primary mt-2" href="{{ url_for('admin_bp.admin_users') }}"><i class="fas fa-list"></i> Show All</a>
    {% else %}
      <h5>No users yet.</h5>
    {% endif %}
  </div>
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
<script>
  function deleteUser(id, name) {
    if (!confirm(`Delete user: ${name}?`)) return;
    fetch(`{{ url_for('admin_bp.delete_user', user_id=0) }}`.replace('0', id), {
      method: 'POST', headers: { 'Content-Type': 'application/json' }
    }).then(r => r.json()).then(d => {
      if (d.success) location.reload(); else alert(d.message || 'Error');
    }).catch(() => alert('Request failed'));
  }
</script>
{% endblock %}
