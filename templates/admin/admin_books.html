{% extends "admin/admin_base.html" %}
{% block title %}Books{% endblock %}
{% block heading %}Manage Books{% endblock %}

{% block content %}
<div class="glass p-3 p-md-4 mb-3">
  <form method="GET" class="row g-2 align-items-center" role="search">
    <div class="col-sm-8 col-md-6">
      <input class="form-control" type="search" name="search" placeholder="Search by title, author, or uploader..." value="{{ search or '' }}">
    </div>
    <div class="col-auto">
      <button class="btn btn-primary"><i class="fas fa-search me-1"></i>Search</button>
      {% if search %}<a class="btn btn-outline-secondary ms-1" href="{{ url_for('admin_bp.admin_books') }}">Clear</a>{% endif %}
    </div>
    <div class="col text-end">
      <span class="text-muted">Total: {{ total_books or 0 }}</span>
    </div>
  </form>
</div>

{% if books %}
<div class="card glass">
  <div class="card-body">
    <div class="table-responsive">
      <table class="table align-middle">
        <thead class="table-light">
          <tr>
            <th>ID</th><th>Title</th><th>Author</th><th>Uploader</th><th>Uploaded</th><th>Downloads</th><th>File</th><th>Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for item in books %}
            {% set b = item.book %}
            <tr>
              <td>{{ b.id }}</td>
              <td class="fw-semibold">{{ b.title }}</td>
              <td>{{ b.author or 'Unknown' }}</td>
              <td><span class="badge bg-secondary">{{ item.username }}</span></td>
              <td>{{ b.upload_date.strftime('%Y-%m-%d') if b.upload_date else 'N/A' }}</td>
              <td><span class="badge bg-success">{{ item.download_count }}</span></td>
              <td>{{ b.filename or '-' }}</td>
              <td>
                <div class="btn-group btn-group-sm">
                  <a class="btn btn-outline-primary" href="{{ url_for('read_book', book_id=b.id) }}" title="Preview"><i class="fas fa-eye"></i></a>
                  <a class="btn btn-outline-success" href="{{ url_for('download_book', book_id=b.id) }}" title="Download"><i class="fas fa-download"></i></a>
                  <button class="btn btn-outline-danger" onclick="deleteBook({{ b.id }}, '{{ b.title }}')" title="Delete"><i class="fas fa-trash"></i></button>
                </div>
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>
{% else %}
<div class="card glass">
  <div class="card-body text-center py-5">
    <i class="fas fa-book fa-3x text-muted mb-3"></i>
    {% if search %}
      <h5>No books match your search.</h5>
      <a class="btn btn-primary mt-2" href="{{ url_for('admin_bp.admin_books') }}"><i class="fas fa-list"></i> Show All</a>
    {% else %}
      <h5>Books uploaded by users will appear here.</h5>
    {% endif %}
  </div>
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
<script>
  function deleteBook(id, title) {
    if (!confirm(`Delete book: ${title}?`)) return;
    fetch(`{{ url_for('admin_bp.admin_delete_book', book_id=0) }}`.replace('0', id), {
      method: 'POST', headers: { 'Content-Type': 'application/json' }
    }).then(r => r.json()).then(d => {
      if (d.success) location.reload(); else alert(d.message || 'Error');
    }).catch(() => alert('Request failed'));
  }
</script>
{% endblock %}
